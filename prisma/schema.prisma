generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// USER MANAGEMENT
// ==========================================

model User {
  id        String     @id @default(cuid())
  email     String     @unique
  password  String
  name      String
  role      UserRole   @default(AGENT)
  status    UserStatus @default(ACTIVE)
  avatar    String?
  phone     String?
  lastLogin DateTime?

  // Password Reset Fields
  resetToken       String?   @unique
  resetTokenExpiry DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  deletedBy String?
  isDeleted Boolean   @default(false)

  // Relations
  activities            ActivityLog[]
  conversations         Conversation[]
  agencies              AgencyUser[]
  invitations           Invitation[]
  notifications         Notification[]
  assignedProperties    Property[]
  assignedVisits        PropertyVisit[]       @relation("AssignedAgent")
  approvedRegistrations RegistrationRequest[] @relation("RegistrationApprover")
  rejectedRegistrations RegistrationRequest[] @relation("RegistrationRejecter")

  @@index([isDeleted])
  @@index([resetToken])
  @@map("users")
}

// ==========================================
// AGENCY (INMOBILIARIA) - Replaces Gym
// ==========================================

model Agency {
  id            String       @id @default(cuid())
  name          String
  slug          String       @unique
  businessType  String?      @default("INMOBILIARIA") // INMOBILIARIA, PROMOTORA, etc.
  licenseNumber String?      // Número de licencia inmobiliaria
  address       String?
  city          String?
  state         String?
  zipCode       String?
  country       String?      @default("España")
  phone         String?
  email         String?
  website       String?
  logo          String?
  zones         String[]     // Zonas de operación
  status        AgencyStatus @default(ACTIVE)
  settings      Json?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  deletedAt     DateTime?
  deletedBy     String?
  isDeleted     Boolean      @default(false)

  // Relations
  aiPrompts            AIPrompt?
  advantages           AgencyAdvantage[]
  users                AgencyUser[]
  invitations          Invitation[]
  leads                Lead[]
  properties           Property[]
  propertyVisits       PropertyVisit[]
  whatsappAccounts     WhatsAppAccount[]
  integrations         Integration[]
  webhooks             Webhook[]
  voiceSessions        VoiceSession[]
  registrationRequests RegistrationRequest[]

  @@index([isDeleted])
  @@map("agencies")
}

model AgencyAdvantage {
  id          String   @id @default(cuid())
  agencyId    String
  title       String
  description String?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  agency      Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@index([agencyId])
  @@map("agency_advantages")
}

model AgencyUser {
  id        String   @id @default(cuid())
  userId    String
  agencyId  String
  role      UserRole @default(AGENT)
  createdAt DateTime @default(now())
  agency    Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, agencyId])
  @@map("agency_users")
}

// ==========================================
// PROPERTY (INMUEBLE)
// ==========================================

model Property {
  id              String            @id @default(cuid())
  agencyId        String
  agentId         String?           // Agente asignado

  // Basic Info
  title           String
  description     String?
  reference       String?           // Referencia interna

  // Property Type & Transaction
  propertyType    PropertyType
  transactionType TransactionType

  // Location
  address         String?
  city            String?
  zone            String?           // Barrio/Zona
  state           String?           // Provincia
  zipCode         String?
  country         String?           @default("España")
  latitude        Float?
  longitude       Float?

  // Characteristics
  price           Float
  pricePerSqm     Float?            // Precio por m²
  sqmTotal        Float?            // Metros cuadrados totales
  sqmBuilt        Float?            // Metros construidos
  sqmUsable       Float?            // Metros útiles
  bedrooms        Int?
  bathrooms       Int?
  floors          Int?              // Número de plantas
  floor           Int?              // Planta del inmueble
  hasElevator     Boolean?          @default(false)
  hasParking      Boolean?          @default(false)
  parkingSpaces   Int?
  hasPool         Boolean?          @default(false)
  hasTerrace      Boolean?          @default(false)
  hasGarden       Boolean?          @default(false)
  hasAC           Boolean?          @default(false)
  hasHeating      Boolean?          @default(false)
  yearBuilt       Int?
  energyRating    String?           // A, B, C, D, E, F, G

  // Additional Features
  features        String[]          // Array de características adicionales

  // Media
  images          String[]          // Array de URLs de imágenes
  videoUrl        String?
  virtualTourUrl  String?

  // Status
  status          PropertyStatus    @default(AVAILABLE)
  featured        Boolean           @default(false)
  publishedAt     DateTime?

  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  deletedAt       DateTime?
  deletedBy       String?
  isDeleted       Boolean           @default(false)

  // Relations
  agency          Agency            @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  agent           User?             @relation(fields: [agentId], references: [id])
  visits          PropertyVisit[]
  leadInterests   LeadPropertyInterest[]

  @@index([agencyId])
  @@index([isDeleted])
  @@index([status])
  @@index([propertyType])
  @@index([transactionType])
  @@index([city])
  @@index([zone])
  @@index([price])
  @@map("properties")
}

// ==========================================
// LEAD (CLIENTE POTENCIAL)
// ==========================================

model Lead {
  id        String     @id @default(cuid())
  agencyId  String
  name      String
  email     String?
  phone     String

  // Real Estate Specific Fields
  transactionInterest TransactionType?  // COMPRA, ALQUILER, VENTA
  propertyTypeInterest PropertyType[]   // Tipos de inmueble de interés
  budgetMin           Float?            // Presupuesto mínimo
  budgetMax           Float?            // Presupuesto máximo
  sqmMin              Float?            // M² mínimos
  sqmMax              Float?            // M² máximos
  bedroomsMin         Int?              // Habitaciones mínimas
  bathroomsMin        Int?              // Baños mínimos
  preferredZones      String[]          // Zonas preferidas
  preferredFeatures   String[]          // Características deseadas
  timeline            String?           // Urgencia: INMEDIATO, 1_MES, 3_MESES, 6_MESES, SIN_PRISA

  // General Fields
  status              LeadStatus        @default(NEW)
  source              LeadSource        @default(WHATSAPP)
  score               Int               @default(0)
  notes               String?
  assignedToId        String?

  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  deletedAt     DateTime?
  deletedBy     String?
  isDeleted     Boolean                @default(false)

  // Relations
  agency            Agency                 @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  activities        ActivityLog[]
  conversations     Conversation[]
  followUps         FollowUp[]
  propertyInterests LeadPropertyInterest[]
  propertyVisits    PropertyVisit[]

  @@unique([agencyId, phone])
  @@index([isDeleted])
  @@index([agencyId, isDeleted])
  @@index([status])
  @@index([assignedToId])
  @@map("leads")
}

// Junction table for Lead-Property interests
model LeadPropertyInterest {
  id         String   @id @default(cuid())
  leadId     String
  propertyId String
  interest   Int      @default(5) // 1-10 nivel de interés
  notes      String?
  createdAt  DateTime @default(now())
  lead       Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([leadId, propertyId])
  @@map("lead_property_interests")
}

// ==========================================
// PROPERTY VISIT (CITA DE VISITA)
// ==========================================

model PropertyVisit {
  id          String           @id @default(cuid())
  agencyId    String
  propertyId  String
  leadId      String
  agentId     String?          // Agente asignado a la visita

  // Scheduling
  scheduledAt DateTime
  duration    Int              @default(30) // Duración en minutos
  endTime     DateTime?

  // Status
  status      VisitStatus      @default(SCHEDULED)

  // Details
  notes       String?
  feedback    String?          // Feedback después de la visita
  rating      Int?             // Valoración del cliente 1-5

  // Reminders
  reminderSent    Boolean      @default(false)
  reminderSentAt  DateTime?
  confirmedAt     DateTime?
  completedAt     DateTime?
  cancelledAt     DateTime?
  cancelReason    String?

  // Timestamps
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relations
  agency      Agency           @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  property    Property         @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  lead        Lead             @relation(fields: [leadId], references: [id], onDelete: Cascade)
  agent       User?            @relation("AssignedAgent", fields: [agentId], references: [id])

  @@index([agencyId])
  @@index([propertyId])
  @@index([leadId])
  @@index([agentId])
  @@index([scheduledAt])
  @@index([status])
  @@map("property_visits")
}

// ==========================================
// VOICEFLOW INTEGRATION
// ==========================================

model VoiceSession {
  id          String   @id @default(cuid())
  agencyId    String
  leadId      String?
  sessionId   String   @unique // Voiceflow session ID
  phone       String?  // Teléfono del cliente

  // Session Data
  transcript  Json?    // Transcripción completa
  intents     String[] // Intenciones detectadas
  entities    Json?    // Entidades extraídas (tipo inmueble, precio, zona, etc.)

  // Extracted Information
  extractedPropertyType    String?
  extractedTransactionType String?
  extractedBudgetMin       Float?
  extractedBudgetMax       Float?
  extractedZones           String[]
  extractedSqm             Float?
  extractedBedrooms        Int?
  appointmentRequested     Boolean  @default(false)
  appointmentDate          DateTime?

  // Status
  status      VoiceSessionStatus @default(ACTIVE)

  // Timestamps
  startedAt   DateTime @default(now())
  endedAt     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  agency      Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@index([agencyId])
  @@index([leadId])
  @@index([sessionId])
  @@index([phone])
  @@map("voice_sessions")
}

// ==========================================
// CONVERSATION & MESSAGES
// ==========================================

model Conversation {
  id          String             @id @default(cuid())
  leadId      String
  userId      String?
  channel     String             @default("whatsapp")
  status      ConversationStatus @default(ACTIVE)
  lastMessage DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  deletedAt   DateTime?
  deletedBy   String?
  isDeleted   Boolean            @default(false)
  lead        Lead               @relation(fields: [leadId], references: [id], onDelete: Cascade)
  user        User?              @relation(fields: [userId], references: [id])
  messages    Message[]

  @@index([isDeleted])
  @@map("conversations")
}

model Message {
  id             String        @id @default(cuid())
  conversationId String
  content        String
  type           MessageType   @default(TEXT)
  sender         MessageSender
  metadata       Json?
  sentAt         DateTime      @default(now())
  deliveredAt    DateTime?
  readAt         DateTime?
  deletedAt      DateTime?
  isDeleted      Boolean       @default(false)
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([isDeleted])
  @@map("messages")
}

// ==========================================
// FOLLOW-UPS
// ==========================================

model FollowUp {
  id          String         @id @default(cuid())
  leadId      String
  type        FollowUpType
  status      FollowUpStatus @default(PENDING)
  scheduledAt DateTime
  completedAt DateTime?
  notes       String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  lead        Lead           @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@map("follow_ups")
}

// ==========================================
// AI PROMPTS
// ==========================================

model AIPrompt {
  id                String   @id @default(cuid())
  agencyId          String   @unique
  systemPrompt      String
  greetingMessage   String?
  qualificationFlow Json?
  objectionHandling Json?
  faqs              Json?
  escalationRules   Json?

  // Real Estate Specific Prompts
  propertyInquiryPrompt    String?  // Prompt para consultas de propiedades
  visitSchedulingPrompt    String?  // Prompt para agendar visitas
  priceNegotiationPrompt   String?  // Prompt para negociación

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  agency            Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@map("ai_prompts")
}

// ==========================================
// WHATSAPP CONFIGURATION
// ==========================================

model WhatsAppMetaConfig {
  id                    String   @id @default(cuid())
  metaBusinessManagerId String?
  metaAppId             String?
  metaAppSecret         String?
  webhookVerifyToken    String?
  webhookUrl            String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("whatsapp_meta_config")
}

model WhatsAppAccount {
  id            String         @id @default(cuid())
  agencyId      String
  phoneNumber   String         @unique
  phoneNumberId String
  accessToken   String
  status        WhatsAppStatus @default(PENDING)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  agency        Agency         @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@map("whatsapp_accounts")
}

// ==========================================
// NOTIFICATIONS
// ==========================================

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// ==========================================
// ACTIVITY LOGS
// ==========================================

model ActivityLog {
  id          String       @id @default(cuid())
  userId      String?
  leadId      String?
  agencyId    String?
  type        ActivityType
  description String
  metadata    Json?
  createdAt   DateTime     @default(now())
  lead        Lead?        @relation(fields: [leadId], references: [id])
  user        User?        @relation(fields: [userId], references: [id])

  @@map("activity_logs")
}

// ==========================================
// INVITATIONS
// ==========================================

model Invitation {
  id        String    @id @default(cuid())
  code      String    @unique
  email     String
  agencyId  String
  role      UserRole
  invitedBy String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  isDeleted Boolean   @default(false)
  deletedAt DateTime?
  deletedBy String?
  agency    Agency    @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  inviter   User      @relation(fields: [invitedBy], references: [id], onDelete: Cascade)

  @@index([isDeleted])
  @@index([code])
  @@index([email])
  @@map("invitations")
}

// ==========================================
// REGISTRATION REQUESTS
// ==========================================

model RegistrationRequest {
  id              String                    @id @default(cuid())
  name            String
  email           String
  phone           String?
  password        String
  role            UserRole
  agencyId        String
  status          RegistrationRequestStatus @default(PENDING)
  requestedBy     String?
  approvedBy      String?
  rejectedBy      String?
  approvedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  agency   Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  approver User?  @relation("RegistrationApprover", fields: [approvedBy], references: [id])
  rejecter User?  @relation("RegistrationRejecter", fields: [rejectedBy], references: [id])

  @@index([status])
  @@index([agencyId])
  @@index([email])
  @@index([role])
  @@map("registration_requests")
}

// ==========================================
// INTEGRATIONS
// ==========================================

model Integration {
  id            String            @id @default(cuid())
  agencyId      String
  type          IntegrationType
  name          String
  status        IntegrationStatus @default(INACTIVE)
  config        Json
  lastSyncAt    DateTime?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  agency        Agency            @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  syncHistory   SyncHistory[]
  fieldMappings FieldMapping[]

  @@unique([agencyId, type])
  @@map("integrations")
}

model SyncHistory {
  id            String      @id @default(cuid())
  integrationId String
  type          SyncType
  status        SyncStatus
  recordsSynced Int         @default(0)
  duration      Int         @default(0)
  errorMessage  String?
  metadata      Json?
  startedAt     DateTime    @default(now())
  completedAt   DateTime?
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([startedAt])
  @@map("sync_history")
}

model FieldMapping {
  id            String      @id @default(cuid())
  integrationId String
  localField    String
  externalField String
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@unique([integrationId, localField])
  @@map("field_mappings")
}

// ==========================================
// WEBHOOKS (for n8n/Make integration)
// ==========================================

model Webhook {
  id            String       @id @default(cuid())
  agencyId      String
  name          String
  url           String
  events        String[]     // Events to trigger: LEAD_CREATED, VISIT_SCHEDULED, etc.
  secret        String?      // For signature verification
  headers       Json?        // Custom headers
  isActive      Boolean      @default(true)
  retryCount    Int          @default(3)
  lastTriggered DateTime?
  failureCount  Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  agency        Agency       @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  webhookLogs   WebhookLog[]

  @@index([agencyId])
  @@index([isActive])
  @@map("webhooks")
}

model WebhookLog {
  id          String   @id @default(cuid())
  webhookId   String
  eventType   String
  payload     Json
  response    Json?
  statusCode  Int?
  duration    Int?
  error       String?
  success     Boolean  @default(false)
  triggeredAt DateTime @default(now())
  webhook     Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  @@index([webhookId])
  @@index([triggeredAt])
  @@index([eventType])
  @@map("webhook_logs")
}

// ==========================================
// ENUMS
// ==========================================

enum RegistrationRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum UserRole {
  ADMIN
  MANAGER
  AGENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum AgencyStatus {
  ACTIVE
  INACTIVE
  TRIAL
}

// Real Estate Property Types
enum PropertyType {
  APARTMENT      // Piso
  HOUSE          // Casa
  VILLA          // Chalet
  PENTHOUSE      // Ático
  DUPLEX         // Dúplex
  STUDIO         // Estudio
  LOFT           // Loft
  TOWNHOUSE      // Adosado
  COUNTRY_HOUSE  // Casa rural
  COMMERCIAL     // Local comercial
  OFFICE         // Oficina
  WAREHOUSE      // Nave industrial
  LAND           // Terreno
  PARKING        // Garaje
  STORAGE        // Trastero
  BUILDING       // Edificio
  OTHER          // Otro
}

enum TransactionType {
  SALE           // Venta
  RENT           // Alquiler
  RENT_TO_OWN    // Alquiler con opción a compra
  TRANSFER       // Traspaso
}

enum PropertyStatus {
  AVAILABLE      // Disponible
  RESERVED       // Reservado
  SOLD           // Vendido
  RENTED         // Alquilado
  UNAVAILABLE    // No disponible
  DRAFT          // Borrador
}

enum VisitStatus {
  SCHEDULED      // Programada
  CONFIRMED      // Confirmada
  IN_PROGRESS    // En curso
  COMPLETED      // Completada
  CANCELLED      // Cancelada
  NO_SHOW        // No se presentó
  RESCHEDULED    // Reprogramada
}

enum VoiceSessionStatus {
  ACTIVE
  COMPLETED
  ABANDONED
  ERROR
}

enum LeadStatus {
  NEW            // Nuevo
  CONTACTED      // Contactado
  QUALIFIED      // Cualificado
  VISITING       // Visitando propiedades
  NEGOTIATING    // Negociando
  CLOSED_WON     // Cerrado ganado
  CLOSED_LOST    // Cerrado perdido
}

enum LeadSource {
  WHATSAPP
  WEBSITE
  INSTAGRAM
  FACEBOOK
  REFERRAL
  PORTAL         // Portales inmobiliarios (Idealista, Fotocasa, etc.)
  VOICEFLOW      // Desde interacción de voz
  PHONE
  WALK_IN
  GOOGLE_ADS
  META_ADS
  OTHER
}

enum ConversationStatus {
  ACTIVE
  CLOSED
  ARCHIVED
}

enum MessageType {
  TEXT
  IMAGE
  DOCUMENT
  AUDIO
  VIDEO
  LOCATION
  PROPERTY_CARD  // Tarjeta de propiedad
}

enum MessageSender {
  AI
  AGENT
  CUSTOMER
  VOICEFLOW
}

enum FollowUpStatus {
  PENDING
  COMPLETED
  CANCELLED
  OVERDUE
}

enum FollowUpType {
  CALL
  WHATSAPP
  EMAIL
  VISIT
  DOCUMENT_REQUEST  // Solicitud de documentos
  OFFER             // Envío de oferta
}

enum WhatsAppStatus {
  ACTIVE
  INACTIVE
  PENDING
}

enum NotificationType {
  NEW_LEAD
  NEW_MESSAGE
  FOLLOW_UP_DUE
  SYSTEM_ALERT
  LEAD_STATUS_CHANGE
  VISIT_SCHEDULED
  VISIT_CONFIRMED
  VISIT_CANCELLED
  VISIT_COMPLETED
  PROPERTY_INQUIRY
  VOICE_SESSION_COMPLETED
  HUMAN_ASSISTANCE_REQUESTED
  REGISTRATION_REQUEST_CREATED
  REGISTRATION_REQUEST_APPROVED
  REGISTRATION_REQUEST_REJECTED
  WEBHOOK_TRIGGERED
}

enum ActivityType {
  LEAD_CREATED
  LEAD_UPDATED
  LEAD_STATUS_CHANGED
  MESSAGE_SENT
  FOLLOW_UP_CREATED
  FOLLOW_UP_COMPLETED
  USER_LOGIN
  CONVERSATION_STARTED
  CONVERSATION_CLOSED
  PROPERTY_CREATED
  PROPERTY_UPDATED
  PROPERTY_DELETED
  VISIT_SCHEDULED
  VISIT_CONFIRMED
  VISIT_COMPLETED
  VISIT_CANCELLED
  VOICE_SESSION_STARTED
  VOICE_SESSION_COMPLETED
  WEBHOOK_TRIGGERED
}

enum IntegrationType {
  HUBSPOT
  SALESFORCE
  ZOHO
  PIPEDRIVE
  GOOGLE_ANALYTICS
  FACEBOOK_PIXEL
  ZAPIER
  N8N
  MAKE
  WEBHOOK
  IDEALISTA       // Portal inmobiliario
  FOTOCASA        // Portal inmobiliario
  CUSTOM
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
  PENDING
}

enum SyncType {
  MANUAL
  AUTO
  SCHEDULED
}

enum SyncStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
  CANCELLED
}
